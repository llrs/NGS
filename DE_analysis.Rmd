---
title: "The weight of the ductular reaction in alcohol liver disease"
author: "[Llu√≠s Revilla](mailto:lrevilla@clinic.cat)"
date: "`r Sys.Date()`"
output:
  BiocStyle::html_document:
    toc: true
  BiocStyle::pdf_document:
    toc: true
---

```{r setup, echo=FALSE, results="asis", message=FALSE}
knitr::opts_chunk$set(tidy = FALSE, echo = TRUE, cache = FALSE, autodep = TRUE)
```

# Alcohol liver disease
## Load disease expression

The data is provided already corrected and log2 transformed in a Excel file. Which I manually converted to csv for a faster reading in R. Also the second sheet of that Excel file had the phenoData used which I stored on a second csv file.

```{r load}
expression <- read.csv("../data/ALD_ramon/NGS_AHsteps.expr.csv", row.names = 1)
phenoData <- read.csv("../data/ALD_ramon/NGS_AHsteps.design.csv", row.names = 1)
```

First we will explore a little bit the data, in case we need to correct something:

```{r exploration1}
library("geneplotter")
summary(phenoData)
phenoData
expression[1:5, 1:5]
```

So we will delete two colums that has the same information as the column G. And we will use more easily readable names

```{r pheno}
phenoData <- phenoData[, c("Sample.id", "G")]
colnames(phenoData) <- c("Sample", "Status")
levels(phenoData$Status) <- c("AH", "Non-responders", "Responders", "C.Comp", 
                              "ASH", "Explants", "HCV", "NASH", "Normal")
phenoData
```
## Check quality
We can observe the quality of the samples with a boxplot and the density of expressions:
```{r q_check}
boxplot(expression, main = "Expression per sample")
multidensity(expression, main = "Densities of expression", legend = NULL)
avgexp <- rowMeans(expression)
hist(avgexp, main = "Histogram of mean expression per gene")
abline(v = 1, col = "red", lwd = 2)
```
There is a lot of differences between samples on the low expressed genes. We should filter those genes that are below 1, as they are unreliable.
```{r remove}
expression <- expression[avgexp > 1, ]
multidensity(expression, main = "Densities of expression", legend = NULL)
```
Now the distribution of the expression between samples is much more comparable. 
As we need only the alcohol samples we remove those who aren't from alcohol:

```{r alcohol}
alcohol <- !phenoData$Status %in% c("HCV", "NASH", "Explants")
expression <- expression[, alcohol]
phenoData <- phenoData[alcohol, ]
```

To work easier with the data I proceed to create an ExpressionSet

```{r ESet, message=FALSE}
library("Biobase")
library("AnnotationDbi")
ALD <- ExpressionSet(as.matrix(expression))
phenoData(ALD) <- AnnotatedDataFrame(phenoData)
ALD
```

## Check the normalizations applied 
We take advantatge of the plotMDS function of limma package to plot the MDS of the samples, to see how close are between them. 

```{r plotMDS, message=FALSE }
library("limma")
plotMDS(ALD, labels = phenoData(ALD)$Status, main = "Samples relationships")
```

We can see that they are clearly separated in two groups, but some samples like the Alcohol Hepatitis samples are on both sites of the first dimension. We can also observe that the cirrhosis compensated samples are closer to the normal or healthy samples.  

## Design 

The design we will use to find the differentially expressed genes is the following:
```{r design}
# To ensure sintactically valid names
names <- make.names(levels(droplevels(phenoData(ALD)$Status))) 
design <- sapply(names, function(x){
  x <- ifelse(x == "Non.responders", "Non-responders", x)
  ifelse(phenoData(ALD)$Status == x, 1, 0)
})
rownames(design) <- rownames(phenoData(ALD))
design
```

As you can see each group has its own colum to increase the power to the model, and to allow for more informative contrasts.
```{r design2}
refact <- function(x){
  if (x == "Normal") {
    0
  } else if ( x == "ASH") {
    1
  } else if (x == "C.Comp") {
    2
  } else if (x == "AH") {
    4
  } else if (x == "Responders") {
    5
  } else if (x == "Non-responders") {
    5
  } else {
    stop("Unexpected level")
  }
}
design2 <- sapply(as.character(phenoData(ALD)$Status), refact)
design2 <- as.matrix(design2)
colnames(design2) <- "Progression"
rownames(design2) <- rownames(phenoData(ALD))
design2
```
We fit each design with the expression of the alcoholic liver disease:

```{r fitting}
fit <- lmFit(exprs(ALD), design)
fit.2 <- lmFit(exprs(ALD), design2)
```

## Contrasts

We are interested in several comparisons, in the first design:
```{r contrasts}
contrasts <- makeContrasts("ASHvsNormal" = ASH - Normal,
                          "CirrhosisVsNormal" = C.Comp - Normal,
                          "AHvsNormal" = AH - Normal,
                          "RespondersVsNormal" = Responders - Normal,
                          "Non-respondersVsNormal" = Non.responders - Normal,
                          
                          # Assuming that some status are similar
                          "SevereVsNormal" = (Responders + Non.responders)/2 - Normal,
                          
                          "RespondersVsNon-responders" = Responders - Non.responders,
                          
                          "CirrhosisVsASH" = C.Comp - ASH,
                          "AHvsCirrhosis" = AH - C.Comp,

                          "Non-respondersVsAH" = Non.responders - AH,
                          "RespondersVsAH" = Responders - AH,
                          "SevereVsHepatitis" = (Non.responders + Responders)/2 - AH,
                          
                          levels = design)
contrasts
```

Given those comparisons of interest we now evaluate the results:

```{r contrast_fit}
fit2 <- contrasts.fit(fit, contrasts)
fit2 <- eBayes(fit2, proportion = 0.1)
results <- decideTests(fit2, adjust.method = "fdr", lfc = log2(2))
summary(results)

fit2.2 <- eBayes(fit.2, proportion = 0.95) 
results2 <- decideTests(fit2.2)
summary(results2)
```

We can observe the quality of the t values over the teoretical quantiles to observe if there is any assumption about the eBayes fitting which doesn't holds. Note that I already modified the expected proportion of genes in the call to eBayes:
```{r qualtiy, fig.height = 84, fig.width = 30 }
par(mfrow = c(ncol(results), 3))
out <- sapply(colnames(results), function(x){
  qqt(fit2$t[, x], df = fit2$df.total, main = paste("Student's t Q-Q Plot of", x))
  abline(0, 1)
  volcanoplot(fit2, coef = x, main = x)
  plotMD(fit2, coef = x, main = x)
})
```
```{r quality1, fig.width = 30, fig.height = 20 }
par(mfrow = c(ncol(results2), 3))
out <- sapply(colnames(results2), function(x){
  qqt(fit2.2$t[, x], df = fit2.2$df.total, main = paste("Student's t Q-Q Plot of", x))
  abline(0, 1)
  volcanoplot(fit2.2, coef = x, main = paste(x))
  plotMD(fit2.2, coef = x, main = x)
})
```
Here we can see on the last plot that the exprsesion of the genes show a bimodal distribution in the progression of the dissease. Which seems to confirm that at one point it descompensates and has a very bad prognossis. 

## Store data
It is a good idea to store the data, not only the program of your analysis, so here I go:
```{r store_ALD}
save(fit, fit2, fit2.2, fit.2, design, design2, ALD, contrasts, file = "ALD.RData")
```

## Differentially expressed genes

We can plot the top 2000 genes with the highest absolute value of log fold-change in each :
```{r DEG_ALD, fig.width = 30, fig.height = 84 }
par(mfrow = c(ncol(results), 2))
out <- sapply(colnames(results), function(x) {
  tt.ALD <- topTable(fit2, coef = x, sort.by = "logFC", number = Inf)
  tt.ALD <- tt.ALD[order(-abs(tt.ALD$logFC)), ]
  plot(density(tt.ALD[1:2000, "logFC"]), 
       main = paste("Distribution of the top 2000 DEG in", x))
  hist(tt.ALD[1:2000, "logFC"], 
       main = paste("Distribution of the top 2000 DEG in", x))
})
```
For the progression model we can plot it too:
```{r DEG_ALD2, fig.width = 30, fig.height = 30 }
par(mfrow = c(1, 2))
tt.ALD2 <- topTable(fit2.2, coef = "Progression", sort.by = "logFC", number = Inf)
tt.ALD2 <- tt.ALD2[order(-abs(tt.ALD2$logFC)), ]
plot(density(tt.ALD2[1:2000, "logFC"]), main = "Distribution of the top 2000 DEG")
hist(tt.ALD2[1:2000, "logFC"], main = "Distribution of the top 2000 DEG")
```

# Ductular Reaction

This data was extracted from a liver, the POS labels indicate that were extracted from a microdisection with KRT7 positive. NEG indicates that for the same microdisection those not stained for KRT7 where taken. TOTAL indicates that there is a mix of KRT7+ and KRT7- dyeing. Also this data has been already normalized.

## Load the data of ductular reaction

```{r load_dr}
pheno <- read.csv("../data/ductular_reaction/samples_def.csv", row.names = 1)
expr <- read.csv("../data/ductular_reaction/POS_NEG_TOTAL_16SAMPLES.csv", row.names = 1)
```
We explore these data:

```{r exploration2}
summary(pheno)
pheno
expr[1:5, 1:5]
```
We can observe the expression has also the symbols of the genes but its main identifier is the RefSeq identifier of NCBI. 
I store in a separte object the symbols, and delete it from the expr object, and build the expression set:
```{r symbols}
orig_symbols <- expr$hgnc_symbol
expr <- expr[, -1]
```
## Check quality
We can observe the quality of each sample with:
```{r quality_check}
boxplot(expr, main = "Expression per sample")
multidensity(expr, main = "Densities of expression", legend = NULL)
avgexp <- rowMeans(expr)
hist(avgexp, main = "Histogram of mean expression per gene")
abline(v = 1, col = "red", lwd = 2)
```
We can observe that the densities differ between samples on the low expression values. We should filter those genes that are below 1, as they are unreliable.  

```{r remove2}
expr <- expr[avgexp > 1, ]
multidensity(expr, main = "Densities of expression", legend = NULL)
```
Now the distribution of the expression between samples is much more comparable. But it still has some perturbation at the peak of the the expression. Nevertheless, we create an Expression Set.
```{r eset}
DR <- ExpressionSet(as.matrix(expr))
phenoData(DR) <- AnnotatedDataFrame(pheno)
DR
```

## Check normalizations
We plot it too the MDS, to see where our samples go
```{r MDS }
plotMDS(DR, labels = phenoData(DR)$Fraction)
```

## Design
In this case each type of expression has come from a different subset of the liver, so we should consider each one as an independent group. 
```{r design3}
design3 <- model.matrix(~0 + phenoData(DR)$Fraction)
colnames(design3) <- substring(colnames(design3), 23)
design3
```
We can fit our design to the expression data:
```{r fitting2}
fit3 <- lmFit(exprs(DR), design3)
```

## Contrasts
We are interested in the Positive vs Negative comparison, but we can compute others too:
```{r comp}
contrasts2 <- makeContrasts("PosVsNegative" = POS - NEG,
                            "PosVsTotal" = POS - TOTAL,
                            "NegVsTotal" = NEG - TOTAL, levels = design3)
contrasts2
```

```{r contrast_fit2}
fit4 <- contrasts.fit(fit3, contrasts2)
fit4 <- eBayes(fit4, proportion = 0.18)
results.DR <- decideTests(fit4, adjust.method = "fdr", lfc = log2(2))
summary(results.DR)
```

We can observe the quality of the t values over the teoretical quantiles to observe if there is any assumption about the eBayes fitting which doesn't holds. Note that I already modified the expected proportion of genes in the call to eBayes:
```{r qualtiy2, fig.width = 30, fig.height = 30 }
par(mfrow = c(3, 3))
out <- sapply(colnames(results.DR), function(x){
  qqt(fit4$t[, x], df = fit4$df.total, main = paste("Student's t Q-Q Plot of", x))
  abline(0, 1)
  volcanoplot(fit4, coef = x, main = x)
  plotMD(fit4, coef = x, main = x)
})

```

## Store the data

```{r store_DR}
save(fit3, fit4, design3, DR, contrasts2,  file = "DR.RData")
```

## Differentially expressed genes
```{r DEG_RD, fig.width = 14, fig.height = 30 }
tt.DR <- topTable(fit4, coef = "PosVsNegative", sort.by = "logFC", number = Inf)
tt.DR <- tt.DR[order(-abs(tt.DR$logFC)), ] # Ordered by the absolute value of logFC
par(mfrow = c(2, 1))
plot(density(tt.DR[1:2000, "logFC"]), main = "Distribution of the top 2000 DEG")
hist(tt.DR[1:2000, "logFC"], main = "Distribution of the top 2000 DEG")
```

# SessionInfo

```{r end}
sessionInfo()
```

